From 0b65dda6f83738f37266158dae33fe93a9e877ab Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Tue, 25 Jan 2022 21:07:09 -0500
Subject: [PATCH 21/51] ima: Move ima_template into ima_namespace

---
 security/integrity/ima/ima.h             |  6 ++++--
 security/integrity/ima/ima_api.c         |  2 +-
 security/integrity/ima/ima_init_ima_ns.c |  8 ++++----
 security/integrity/ima/ima_main.c        |  3 ++-
 security/integrity/ima/ima_policy.c      |  4 ++--
 security/integrity/ima/ima_template.c    | 22 +++++++++++-----------
 6 files changed, 24 insertions(+), 21 deletions(-)

diff --git a/security/integrity/ima/ima.h b/security/integrity/ima/ima.h
index 60c0399899db..8465ee66ae77 100644
--- a/security/integrity/ima/ima.h
+++ b/security/integrity/ima/ima.h
@@ -188,6 +188,8 @@ struct ima_namespace {
 	bool ima_process_keys;
 
 	struct ima_config config;
+
+	struct ima_template_desc *ima_template;
 } __randomize_layout;
 extern struct ima_namespace init_ima_ns;
 
@@ -240,7 +242,7 @@ void ima_print_digest(struct seq_file *m, u8 *digest, u32 size);
 int template_desc_init_fields(const char *template_fmt,
 			      const struct ima_template_field ***fields,
 			      int *num_fields);
-struct ima_template_desc *ima_template_desc_current(void);
+struct ima_template_desc *ima_template_desc_current(struct ima_namespace *ns);
 struct ima_template_desc *ima_template_desc_buf(void);
 struct ima_template_desc *lookup_template_desc(const char *name);
 bool ima_template_has_modsig(const struct ima_template_desc *ima_template);
@@ -251,7 +253,7 @@ int ima_restore_measurement_list(struct ima_namespace *ns,
 void ima_free_measurements(struct ima_namespace *ns);
 int ima_measurements_show(struct seq_file *m, void *v);
 unsigned long ima_get_binary_runtime_size(struct ima_namespace *ns);
-int ima_init_template(void);
+int ima_init_template(struct ima_namespace *ns);
 void ima_init_template_list(void);
 int ima_init_digests(struct ima_namespace *ns);
 void ima_free_digests(struct ima_namespace *ns);
diff --git a/security/integrity/ima/ima_api.c b/security/integrity/ima/ima_api.c
index 30845ec57212..2145e4f23007 100644
--- a/security/integrity/ima/ima_api.c
+++ b/security/integrity/ima/ima_api.c
@@ -47,7 +47,7 @@ int ima_alloc_init_template(struct ima_namespace *ns,
 	if (desc)
 		template_desc = desc;
 	else
-		template_desc = ima_template_desc_current();
+		template_desc = ima_template_desc_current(ns);
 
 	*entry = kzalloc(struct_size(*entry, template_data,
 				     template_desc->num_fields),
diff --git a/security/integrity/ima/ima_init_ima_ns.c b/security/integrity/ima/ima_init_ima_ns.c
index f6f15bafb24b..3f3de0e0b859 100644
--- a/security/integrity/ima/ima_init_ima_ns.c
+++ b/security/integrity/ima/ima_init_ima_ns.c
@@ -61,11 +61,11 @@ int ima_init_namespace(struct ima_namespace *ns)
 	if (rc < 0)
 		goto err_deregister_notifier;
 
-	if (ns == &init_ima_ns) {
-		rc = ima_init_template();
-		if (rc != 0)
-			goto err_deinit_crypto;
+	rc = ima_init_template(ns);
+	if (rc != 0)
+		goto err_deinit_crypto;
 
+	if (ns == &init_ima_ns) {
 		/* It can be called before ima_init_digests(), it does not use TPM. */
 		ima_load_kexec_buffer();
 	}
diff --git a/security/integrity/ima/ima_main.c b/security/integrity/ima/ima_main.c
index edef40c53ee7..ec0f02ed1a49 100644
--- a/security/integrity/ima/ima_main.c
+++ b/security/integrity/ima/ima_main.c
@@ -37,7 +37,8 @@ int ima_appraise;
 
 static int __init hash_setup(struct ima_config *ic, char *str)
 {
-	struct ima_template_desc *template_desc = ima_template_desc_current();
+	struct ima_namespace *ns = &init_ima_ns;
+	struct ima_template_desc *template_desc = ima_template_desc_current(ns);
 	int i;
 
 	if (ic->hash_setup_done)
diff --git a/security/integrity/ima/ima_policy.c b/security/integrity/ima/ima_policy.c
index a0b5ac32c34a..da7e33b5cfdf 100644
--- a/security/integrity/ima/ima_policy.c
+++ b/security/integrity/ima/ima_policy.c
@@ -700,7 +700,7 @@ int ima_match_policy(struct ima_namespace *ns,
 	struct list_head *ima_rules_tmp;
 
 	if (template_desc && !*template_desc)
-		*template_desc = ima_template_desc_current();
+		*template_desc = ima_template_desc_current(ns);
 
 	rcu_read_lock();
 	ima_rules_tmp = rcu_dereference(ns->ima_rules);
@@ -1837,7 +1837,7 @@ static int ima_parse_rule(struct user_namespace *user_ns,
 
 	if (!result && entry->flags & IMA_MODSIG_ALLOWED) {
 		template_desc = entry->template ? entry->template :
-						  ima_template_desc_current();
+						  ima_template_desc_current(ns);
 		check_template_modsig(template_desc);
 	}
 
diff --git a/security/integrity/ima/ima_template.c b/security/integrity/ima/ima_template.c
index b5405d51930e..0091108c994b 100644
--- a/security/integrity/ima/ima_template.c
+++ b/security/integrity/ima/ima_template.c
@@ -74,7 +74,6 @@ static const struct ima_template_field supported_fields[] = {
 #define MAX_TEMPLATE_NAME_LEN \
 	sizeof("d-ng|n-ng|evmsig|xattrnames|xattrlengths|xattrvalues|iuid|igid|imode")
 
-static struct ima_template_desc *ima_template;
 static struct ima_template_desc *ima_buf_template;
 
 /**
@@ -103,7 +102,7 @@ static int __init ima_template_setup(char *str)
 	struct ima_template_desc *template_desc;
 	int template_len = strlen(str);
 
-	if (ima_template)
+	if (ns->ima_template)
 		return 1;
 
 	ima_init_template_list();
@@ -129,7 +128,7 @@ static int __init ima_template_setup(char *str)
 		return 1;
 	}
 
-	ima_template = template_desc;
+	ns->ima_template = template_desc;
 	return 1;
 }
 __setup("ima_template=", ima_template_setup);
@@ -137,8 +136,9 @@ __setup("ima_template=", ima_template_setup);
 static int __init ima_template_fmt_setup(char *str)
 {
 	int num_templates = ARRAY_SIZE(builtin_templates);
+	struct ima_namespace *ns = &init_ima_ns;
 
-	if (ima_template)
+	if (ns->ima_template)
 		return 1;
 
 	if (template_desc_init_fields(str, NULL, NULL) < 0) {
@@ -148,7 +148,7 @@ static int __init ima_template_fmt_setup(char *str)
 	}
 
 	builtin_templates[num_templates - 1].fmt = str;
-	ima_template = builtin_templates + num_templates - 1;
+	ns->ima_template = builtin_templates + num_templates - 1;
 
 	return 1;
 }
@@ -265,14 +265,14 @@ void ima_init_template_list(void)
 	spin_unlock(&template_list);
 }
 
-struct ima_template_desc *ima_template_desc_current(void)
+struct ima_template_desc *ima_template_desc_current(struct ima_namespace *ns)
 {
-	if (!ima_template) {
+	if (!ns->ima_template) {
 		ima_init_template_list();
-		ima_template =
+		ns->ima_template =
 		    lookup_template_desc(CONFIG_IMA_DEFAULT_TEMPLATE);
 	}
-	return ima_template;
+	return ns->ima_template;
 }
 
 struct ima_template_desc *ima_template_desc_buf(void)
@@ -284,9 +284,9 @@ struct ima_template_desc *ima_template_desc_buf(void)
 	return ima_buf_template;
 }
 
-int ima_init_template(void)
+int ima_init_template(struct ima_namespace *ns)
 {
-	struct ima_template_desc *template = ima_template_desc_current();
+	struct ima_template_desc *template = ima_template_desc_current(ns);
 	int result;
 
 	result = template_desc_init_fields(template->fmt,
-- 
2.31.1

