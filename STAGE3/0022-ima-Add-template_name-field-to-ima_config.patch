From 92ed968b83537ac251cd53f3247e1931bebcb4e4 Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Wed, 26 Jan 2022 09:30:18 -0500
Subject: [PATCH 22/48] ima: Add template_name field to ima_config

---
 security/integrity/ima/ima.h             | 2 ++
 security/integrity/ima/ima_init_ima_ns.c | 1 +
 security/integrity/ima/ima_template.c    | 4 ++++
 3 files changed, 7 insertions(+)

diff --git a/security/integrity/ima/ima.h b/security/integrity/ima/ima.h
index 8465ee66ae77..8a7fe6fba0b5 100644
--- a/security/integrity/ima/ima.h
+++ b/security/integrity/ima/ima.h
@@ -125,6 +125,8 @@ struct ima_h_table {
 struct ima_config {
 	int ima_hash_algo;
 	int hash_setup_done;
+
+	char template_name[32];
 };
 
 struct ima_namespace {
diff --git a/security/integrity/ima/ima_init_ima_ns.c b/security/integrity/ima/ima_init_ima_ns.c
index 3f3de0e0b859..d38c808d279d 100644
--- a/security/integrity/ima/ima_init_ima_ns.c
+++ b/security/integrity/ima/ima_init_ima_ns.c
@@ -107,6 +107,7 @@ struct ima_namespace init_ima_ns = {
 	.active = ATOMIC_INIT(1),
 	.config = {
 		.ima_hash_algo = HASH_ALGO_SHA1,
+		.template_name = CONFIG_IMA_DEFAULT_TEMPLATE,
 	},
 };
 EXPORT_SYMBOL(init_ima_ns);
diff --git a/security/integrity/ima/ima_template.c b/security/integrity/ima/ima_template.c
index 0091108c994b..5355a530e915 100644
--- a/security/integrity/ima/ima_template.c
+++ b/security/integrity/ima/ima_template.c
@@ -129,6 +129,10 @@ static int __init ima_template_setup(char *str)
 	}
 
 	ns->ima_template = template_desc;
+
+	strscpy(ns->config.template_name, str,
+		sizeof(ns->config.template_name));
+
 	return 1;
 }
 __setup("ima_template=", ima_template_setup);
-- 
2.31.1

