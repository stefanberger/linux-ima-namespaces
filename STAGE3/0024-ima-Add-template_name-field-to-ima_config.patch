From a4d67daed120c3ae7bfbb8d2154cf016c4b5ea6c Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Wed, 26 Jan 2022 09:30:18 -0500
Subject: [PATCH 24/53] ima: Add template_name field to ima_config

---
 security/integrity/ima/ima.h             | 2 ++
 security/integrity/ima/ima_init_ima_ns.c | 1 +
 security/integrity/ima/ima_template.c    | 4 ++++
 3 files changed, 7 insertions(+)

diff --git a/security/integrity/ima/ima.h b/security/integrity/ima/ima.h
index da19e7a133a7..7bb691785f01 100644
--- a/security/integrity/ima/ima.h
+++ b/security/integrity/ima/ima.h
@@ -125,6 +125,8 @@ struct ima_h_table {
 struct ima_config {
 	int ima_hash_algo;
 	int hash_setup_done;
+
+	char template_name[32];
 };
 
 struct ima_namespace {
diff --git a/security/integrity/ima/ima_init_ima_ns.c b/security/integrity/ima/ima_init_ima_ns.c
index 3668b00bc418..4b4ab1c87ca6 100644
--- a/security/integrity/ima/ima_init_ima_ns.c
+++ b/security/integrity/ima/ima_init_ima_ns.c
@@ -107,6 +107,7 @@ struct ima_namespace init_ima_ns = {
 	.active = ATOMIC_INIT(1),
 	.config = {
 		.ima_hash_algo = HASH_ALGO_SHA1,
+		.template_name = CONFIG_IMA_DEFAULT_TEMPLATE,
 	},
 };
 EXPORT_SYMBOL(init_ima_ns);
diff --git a/security/integrity/ima/ima_template.c b/security/integrity/ima/ima_template.c
index b1caf659ed1d..9a1ddd4cb739 100644
--- a/security/integrity/ima/ima_template.c
+++ b/security/integrity/ima/ima_template.c
@@ -131,6 +131,10 @@ static int __init ima_template_setup(char *str)
 
 	ns->ima_template = template_desc;
 	ns->template_setup_done = 1;
+
+	strscpy(ns->config.template_name, str,
+		sizeof(ns->config.template_name));
+
 	return 1;
 }
 __setup("ima_template=", ima_template_setup);
-- 
2.31.1

