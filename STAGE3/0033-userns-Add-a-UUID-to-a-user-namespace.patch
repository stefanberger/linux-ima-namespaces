From 0512c6bf27d61cee56236ce5817b8ccdbc44efa7 Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Wed, 6 Apr 2022 12:45:27 -0400
Subject: [PATCH 33/89] userns: Add a UUID to a user namespace

Add a UUID to a user namespace to use it for logging IMA related events
so they can be identified where they came from.

Signed-off-by: Stefan Berger <stefanb@linux.ibm.com>
---
 include/linux/user_namespace.h | 2 ++
 kernel/user_namespace.c        | 1 +
 2 files changed, 3 insertions(+)

diff --git a/include/linux/user_namespace.h b/include/linux/user_namespace.h
index c4b4f07b642e..a3b53d75bb2d 100644
--- a/include/linux/user_namespace.h
+++ b/include/linux/user_namespace.h
@@ -10,6 +10,7 @@
 #include <linux/rwsem.h>
 #include <linux/sysctl.h>
 #include <linux/err.h>
+#include <linux/uuid.h>
 
 #define UID_GID_MAP_MAX_BASE_EXTENTS 5
 #define UID_GID_MAP_MAX_EXTENTS 340
@@ -111,6 +112,7 @@ struct user_namespace {
 	 */
 	struct ima_namespace	*ima_ns;
 #endif
+	uuid_t uuid;
 } __randomize_layout;
 
 struct ucounts {
diff --git a/kernel/user_namespace.c b/kernel/user_namespace.c
index 2627c0b6a41d..e2eddf4c8c3f 100644
--- a/kernel/user_namespace.c
+++ b/kernel/user_namespace.c
@@ -160,6 +160,7 @@ int create_user_ns(struct cred *new)
 		goto fail_keyring;
 
 	set_cred_user_ns(new, ns);
+	uuid_gen(&ns->uuid);
 	return 0;
 fail_keyring:
 #ifdef CONFIG_PERSISTENT_KEYRINGS
-- 
2.40.1

