From 8f09cdc48c11ac3e9dfe1c4abd41d6a0de80fb40 Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Wed, 18 May 2022 15:04:10 -0400
Subject: [PATCH 84/89] evm: Enable EVM securityfs also for EVM namespace

Enable EVM securityfs also for EVM namespaces. Initialize it when
securityfs is mounted.

Signed-off-by: Stefan Berger <stefanb@linux.ibm.com>
---
 include/linux/evm.h                | 15 ++++++++++++++-
 security/integrity/evm/evm.h       |  1 -
 security/integrity/evm/evm_main.c  |  3 ++-
 security/integrity/evm/evm_secfs.c | 10 ++++++----
 security/integrity/ima/ima_fs.c    |  4 ++++
 5 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/include/linux/evm.h b/include/linux/evm.h
index de54611abba4..62a520dc1399 100644
--- a/include/linux/evm.h
+++ b/include/linux/evm.h
@@ -54,12 +54,25 @@ struct evm_namespace {
 
 extern struct evm_namespace init_evm_ns;
 
-#if defined(CONFIG_IMA_NS) && defined(CONFIG_EVM)
+#if defined(CONFIG_IMA_NS) || defined(CONFIG_EVM)
 extern struct evm_namespace *create_evm_ns
 				(struct integrity_namespace *integrity_ns);
 extern void free_evm_ns(struct integrity_namespace *evm_ns);
 #endif
 
+#ifdef CONFIG_EVM
+int evm_init_secfs(struct integrity_namespace *ns,
+		   struct dentry *secfs_root,
+		   struct dentry *integrity_dir);
+#else
+static inline int evm_init_secfs(struct integrity_namespace *ns,
+				 struct dentry *secfs_root,
+				 struct dentry *integrity_dir)
+{
+	return 0;
+}
+#endif
+
 #ifdef CONFIG_EVM
 extern int evm_set_key(struct evm_namespace *ns, void *key, size_t keylen);
 extern enum integrity_status evm_verifyxattr(struct evm_namespace *ns,
diff --git a/security/integrity/evm/evm.h b/security/integrity/evm/evm.h
index 29fb36f2f616..c2e3b7a1fa98 100644
--- a/security/integrity/evm/evm.h
+++ b/security/integrity/evm/evm.h
@@ -62,7 +62,6 @@ int evm_calc_hash(struct evm_namespace *ns, struct dentry *dentry,
 		  struct evm_digest *data);
 int evm_init_hmac(struct evm_namespace *ns, struct inode *inode,
 		  const struct xattr *xattr, char *hmac_val);
-int evm_init_secfs(struct evm_namespace *ns);
 int __init evm_init_ns(void);
 int evm_init_namespace(struct evm_namespace *ns,
 		       struct integrity_namespace *integrity_ns);
diff --git a/security/integrity/evm/evm_main.c b/security/integrity/evm/evm_main.c
index dafed138d654..8fdbfd1585fa 100644
--- a/security/integrity/evm/evm_main.c
+++ b/security/integrity/evm/evm_main.c
@@ -1023,7 +1023,8 @@ static int __init init_evm(void)
 	if (error)
 		goto error;
 
-	error = evm_init_secfs(ns);
+	error = evm_init_secfs(ns->integrity_ns, NULL,
+			       ns->integrity_ns->integrity_dir);
 	if (error < 0) {
 		pr_info("Error registering secfs\n");
 		goto error;
diff --git a/security/integrity/evm/evm_secfs.c b/security/integrity/evm/evm_secfs.c
index 0a5cd2a25666..72ab88eb30b5 100644
--- a/security/integrity/evm/evm_secfs.c
+++ b/security/integrity/evm/evm_secfs.c
@@ -386,16 +386,18 @@ static const struct file_operations evm_active_ops = {
 	.write = evm_write_active,
 };
 
-int __init evm_init_secfs(struct evm_namespace *ns)
+int evm_init_secfs(struct integrity_namespace *integrity_ns,
+		   struct dentry *root,
+		   struct dentry *integrity_dir)
 {
+	struct evm_namespace *ns = integrity_ns->evm_ns;
 	struct dentry *evm_dir;
 	struct dentry *evm_init_tpm = NULL;
 	struct dentry *evm_symlink = NULL;
 	struct dentry *evm_active = NULL;
 	int error = 0;
 
-	evm_dir = securityfs_create_dir("evm",
-					ns->integrity_ns->integrity_dir);
+	evm_dir = securityfs_create_dir("evm", integrity_dir);
 	if (!evm_dir || IS_ERR(evm_dir))
 		return -EFAULT;
 
@@ -407,7 +409,7 @@ int __init evm_init_secfs(struct evm_namespace *ns)
 		goto out;
 	}
 
-	evm_symlink = securityfs_create_symlink("evm", NULL,
+	evm_symlink = securityfs_create_symlink("evm", root,
 						"integrity/evm/evm", NULL);
 	if (!evm_symlink || IS_ERR(evm_symlink)) {
 		error = -EFAULT;
diff --git a/security/integrity/ima/ima_fs.c b/security/integrity/ima/ima_fs.c
index 322344175a36..dcedc660a29d 100644
--- a/security/integrity/ima/ima_fs.c
+++ b/security/integrity/ima/ima_fs.c
@@ -23,6 +23,7 @@
 #include <linux/vmalloc.h>
 #include <linux/ima.h>
 #include <linux/integrity_namespace.h>
+#include <linux/evm.h>
 
 #include "ima.h"
 
@@ -705,6 +706,9 @@ int ima_fs_ns_init(struct user_namespace *user_ns, struct dentry *root)
 			ret = PTR_ERR(int_dir);
 			goto free_ns;
 		}
+		ret = evm_init_secfs(user_ns->integrity_ns, root, int_dir);
+		if (ret)
+			goto free_ns;
 	} else {
 		int_dir = ns->integrity_ns->integrity_dir;
 	}
-- 
2.40.1

