From fbdad4fbc5adf6b02acc6e490751e7ab1b9d0dd2 Mon Sep 17 00:00:00 2001
From: Stefan Berger <stefanb@linux.ibm.com>
Date: Mon, 24 Jan 2022 09:53:22 -0500
Subject: [PATCH 72/89] ima: Namespace the IMA_HASH and IMA_HASHED flags

Move the IMA_HASH and IMA_HASHED flags from the iint into the ns_status
structure to prepare for enablement of hash policy rules for each IMA
namespace.

Signed-off-by: Stefan Berger <stefanb@linux.ibm.com>
---
 security/integrity/ima/ima.h           | 8 ++++----
 security/integrity/ima/ima_ns_status.c | 3 +--
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/security/integrity/ima/ima.h b/security/integrity/ima/ima.h
index 163b5c479b5a..ada729cbbd72 100644
--- a/security/integrity/ima/ima.h
+++ b/security/integrity/ima/ima.h
@@ -623,7 +623,8 @@ static inline int ima_filter_rule_match(u32 secid, u32 field, u32 op,
 #define	POLICY_FILE_FLAGS	S_IWUSR
 #endif /* CONFIG_IMA_READ_POLICY */
 
-#define IMA_NS_STATUS_ACTIONS   (IMA_AUDIT | IMA_MEASURE | IMA_APPRAISE)
+#define IMA_NS_STATUS_ACTIONS   (IMA_AUDIT | IMA_MEASURE | IMA_APPRAISE | \
+				 IMA_HASH)
 #define IMA_NS_STATUS_FLAGS     (IMA_AUDIT | IMA_AUDITED | \
 				 IMA_MEASURE | IMA_MEASURED | IMA_COLLECTED | \
 				 IMA_PERMIT_DIRECTIO | IMA_DIGSIG_REQUIRED | \
@@ -631,9 +632,8 @@ static inline int ima_filter_rule_match(u32 secid, u32 field, u32 op,
 				 IMA_APPRAISE | IMA_APPRAISED | \
 				 IMA_FILE_APPRAISED | IMA_MMAP_APPRAISED | \
 				 IMA_BPRM_APPRAISED | IMA_READ_APPRAISED | \
-				 IMA_CREDS_APPRAISED | IMA_READ_APPRAISED)
-
-#define IMA_IINT_FLAGS		(IMA_APPRAISE | IMA_HASH)
+				 IMA_CREDS_APPRAISED | IMA_READ_APPRAISED | \
+				 IMA_HASH | IMA_HASHED)
 
 static inline unsigned long iint_flags(struct integrity_iint_cache *iint,
 				       struct ns_status *ns_status)
diff --git a/security/integrity/ima/ima_ns_status.c b/security/integrity/ima/ima_ns_status.c
index 7e102d1ac449..1428e8b777f2 100644
--- a/security/integrity/ima/ima_ns_status.c
+++ b/security/integrity/ima/ima_ns_status.c
@@ -138,8 +138,7 @@ static void ns_status_free(struct ima_namespace *ns,
  */
 static bool __iint_is_unused(struct integrity_iint_cache *iint)
 {
-	return list_empty(&iint->ns_list) &&
-		(iint_flags(iint, NULL) & IMA_IINT_FLAGS) == 0;
+	return list_empty(&iint->ns_list);
 }
 
 static bool iint_is_unused(struct integrity_iint_cache *iint)
-- 
2.40.1

